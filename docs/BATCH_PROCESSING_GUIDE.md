# 综合处理功能使用指南

## 功能概述

综合处理功能允许用户通过预定义的JSON模板，一键完成复杂的视频处理任务。该功能支持：

- 📋 模板化管理：创建、加载、验证处理模板
- 🔄 参数替换：自动将用户输入替换到模板中
- 🚀 任务编排：自动管理任务依赖关系和执行顺序
- 📊 进度跟踪：实时显示处理进度和状态
- 🎬 结果展示：直观展示处理结果

## 模板格式

模板是JSON格式的文件，定义了处理流程和参数。

### 模板结构

```json
{
  "name": "模板名称",
  "description": "模板描述",
  "version": "1.0",
  "parameters": {
    "parameter_name": {
      "type": "string|number|array",
      "description": "参数描述",
      "default": "默认值"
    }
  },
  "tasks": [
    {
      "id": "task_id",
      "name": "任务名称",
      "type": "tts|subtitle|image_process|video_editor|video_transition|video_merge",
      "params": {
        "param_name": "${parameter_name}"
      },
      "depends_on": ["task_id1", "task_id2"]
    }
  ]
}
```

### 参数类型

- `string`: 字符串类型
- `number`: 数字类型
- `array`: 数组类型

### 任务类型

- `tts`: 语音合成
- `subtitle`: 字幕生成
- `image_process`: 图像处理
- `video_editor`: 视频编辑（包括花字、水印等）
- `video_transition`: 视频转场
- `video_merge`: 视频合并

### 参数引用

在模板中可以使用 `${parameter_name}` 或 `${task_id.output_key}` 来引用参数或任务输出。

## 使用步骤

### 1. 选择模板

在"综合处理"标签页中，从下拉菜单选择要使用的模板。

### 2. 输入参数

根据模板的参数定义，输入相应的值：

- **用户名**: 目标用户的名字
- **年龄**: 目标用户的年龄
- **主题**: 主题文字（如：生日快乐、儿童节快乐）
- **操作模板对象**: 角色对象（如：奥特曼、艾莎公主）
- **二级对象**: 更具体的角色（可选）
- **TTS文本内容**: 要合成的语音文本
- **用户图片**: 上传0-5张用户图片

### 3. 开始处理

点击"🚀 开始处理"按钮，系统将自动：

1. 验证模板和参数
2. 构建任务依赖图
3. 按拓扑顺序执行任务
4. 实时显示处理进度
5. 展示处理结果

## 示例模板

### 生日祝福视频模板

模板文件：`templates/birthday_video_template.json`

功能：
- 语音合成：合成生日祝福语音
- 字幕生成：生成对应的字幕
- 图片处理：处理用户图片（去背景、调整大小）
- 视频编辑：添加花字、用户图片、角色图片
- 视频合成：将所有元素合成为最终视频

### 简单视频处理模板

模板文件：`templates/simple_video_template.json`

功能：
- 字幕生成：为视频添加字幕
- 视频编辑：添加花字

## 自定义模板

### 创建新模板

1. 在 `templates/` 目录下创建新的JSON文件
2. 按照模板格式定义处理流程
3. 重新加载应用，模板将自动加载

### 模板最佳实践

1. **命名规范**: 使用有意义的模板名称
2. **参数设计**: 提供合理的默认值
3. **任务依赖**: 正确设置任务依赖关系
4. **错误处理**: 为关键任务添加错误处理
5. **文档说明**: 提供清晰的模板描述

## 进阶功能

### 任务依赖

使用 `depends_on` 字段定义任务依赖关系：

```json
{
  "id": "task2",
  "name": "任务2",
  "type": "video_editor",
  "params": {
    "input": "${task1.output}"
  },
  "depends_on": ["task1"]
}
```

### 引用任务输出

在参数中引用其他任务的输出：

```json
{
  "params": {
    "input": "${subtitle_task.output}",
    "audio": "${tts_task.output}"
  }
}
```

### 条件执行

根据参数值动态调整任务参数：

```json
{
  "params": {
    "text": "${theme}！${username}",
    "character": "${character}",
    "sub_character": "${sub_character || ''}"
  }
}
```

## 故障排除

### 模板加载失败

1. 检查JSON格式是否正确
2. 检查必需字段是否存在
3. 查看日志了解详细错误信息

### 参数替换失败

1. 确保参数名称与模板定义一致
2. 检查参数类型是否匹配
3. 验证默认值是否合理

### 任务执行失败

1. 检查任务类型是否支持
2. 验证任务参数是否正确
3. 确认任务依赖关系是否正确

## 技术架构

### 核心模块

1. **TemplateManager**: 模板管理器
   - 加载和验证模板
   - 管理模板生命周期

2. **ParameterResolver**: 参数解析器
   - 替换模板中的参数占位符
   - 引用任务输出

3. **TaskOrchestrator**: 任务编排器
   - 构建任务依赖图
   - 拓扑排序
   - 执行任务

4. **BatchProcessingUI**: 综合处理界面
   - 用户交互
   - 进度显示
   - 结果展示

### 执行流程

```
用户输入 → 参数验证 → 模板加载 → 参数替换 → 任务编排 → 任务执行 → 结果展示
```

## 扩展指南

### 添加新的任务类型

1. 在 `TaskOrchestrator` 中注册任务处理器
2. 实现任务处理逻辑
3. 在模板中使用新任务类型

### 自定义参数类型

1. 在 `ParameterResolver` 中添加类型支持
2. 实现类型验证和转换逻辑
3. 在模板中使用新参数类型

## 常见问题

**Q: 如何创建自己的模板？**

A: 在 `templates/` 目录下创建JSON文件，按照模板格式定义处理流程。

**Q: 模板支持多少个任务？**

A: 理论上没有限制，但建议控制在10-20个任务以内，以保持可维护性。

**Q: 如何调试模板？**

A: 查看日志输出，检查参数替换和任务执行情况。

**Q: 支持哪些任务类型？**

A: 目前支持：tts、subtitle、image_process、video_editor、video_transition、video_merge。

## 更新日志

### v1.0.0 (2026-01-18)

- ✨ 初始版本发布
- ✨ 支持模板化管理
- ✨ 支持参数替换
- ✨ 支持任务编排
- ✨ 支持进度跟踪
- ✨ 提供示例模板

## 联系方式

如有问题或建议，请联系开发团队。